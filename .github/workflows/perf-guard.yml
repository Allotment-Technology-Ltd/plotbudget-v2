# Performance Guard — CI enforcement for apps/web.
# Implements every rule defined in rules.yaml.
# Runs on PRs that touch apps/web/** or the rules/scripts themselves.
#
# Required secrets (same as ci.yml where applicable):
#   GITHUB_TOKEN — provided automatically by Actions
#
# Optional secrets for Lighthouse CI:
#   LHCI_GITHUB_APP_TOKEN — for LHCI GitHub App status checks
#   LHCI_SERVER_BASE_URL  — for self-hosted LHCI server (falls back to temporary-public-storage)
#
# Thresholds (override via repository variables or env):
#   BUNDLE_MAX_KB            (default 300)
#   NEW_DEP_THRESHOLD_KB     (default 250)
#   LHCI_PERF_THRESHOLD      (default 90)
#   LHCI_REGRESSION_THRESHOLD (default 5)

name: Perf Guard

on:
  pull_request_target:
    branches: [main]
    paths:
      - 'apps/web/**'
      - 'packages/**'
      - 'rules.yaml'
      - 'lhci-apps-web.config.js'
      - 'scripts/check-next-image-optimizer.js'
      - 'scripts/find-plain-img.js'
      - 'scripts/enforce-image-attrs.js'
      - 'scripts/parse-webpack-stats.js'
      - 'scripts/find-unused-use-client.js'
      - 'scripts/check-new-deps.js'
      - 'scripts/check-dep-versions.js'
      - 'scripts/validate-ci-prereqs.js'
      - 'scripts/validate-exceptions.js'
      - '.github/workflows/perf-guard.yml'

# Minimal permissions — read code, write checks/PR comments.
permissions:
  contents: read
  checks: write
  pull-requests: write

env:
  BUNDLE_MAX_KB: ${{ vars.BUNDLE_MAX_KB || '300' }}
  NEW_DEP_THRESHOLD_KB: ${{ vars.NEW_DEP_THRESHOLD_KB || '250' }}
  LHCI_PERF_THRESHOLD: ${{ vars.LHCI_PERF_THRESHOLD || '90' }}
  LHCI_REGRESSION_THRESHOLD: ${{ vars.LHCI_REGRESSION_THRESHOLD || '5' }}

jobs:
  # ── 0. Preflight: verify all required scripts and workflow files are present ──
  ci-health:
    name: ci-health — prereqs exist
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request_target' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Validate CI prerequisites
        run: node scripts/validate-ci-prereqs.js

  # ── 1. Image optimisation: images.unoptimized must NOT be true ──────────────
  no-next-unoptimized:
    name: no-next-unoptimized — images.unoptimized check
    runs-on: ubuntu-latest
    needs: ci-health
    if: github.event_name != 'pull_request_target' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Check images.unoptimized is not true
        run: node scripts/check-next-image-optimizer.js --path apps/web/next.config.js

  # ── 2. Plain <img> tags must not exist in apps/web ──────────────────────────
  find-plain-img:
    name: find-plain-img — no raw img tags
    runs-on: ubuntu-latest
    needs: ci-health
    if: github.event_name != 'pull_request_target' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Detect plain img elements
        run: node scripts/find-plain-img.js --path apps/web

  # ── 3. Image attribute enforcement (width/height or fill) ───────────────────
  enforce-image-attrs:
    name: enforce-image-attrs — explicit sizing
    runs-on: ubuntu-latest
    needs: ci-health
    if: github.event_name != 'pull_request_target' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Check image attribute completeness
        # --fail promotes this to an error exit; remove the flag to downgrade to advisory.
        run: node scripts/enforce-image-attrs.js --path apps/web --fail

  # ── 4. No blocking server fetch in public layouts ───────────────────────────
  no-blocking-server-fetch:
    name: no-blocking-server-fetch — public layouts
    runs-on: ubuntu-latest
    needs: ci-health
    if: github.event_name != 'pull_request_target' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Grep for blocking server fetches in public layouts
        run: |
          # This grep intentionally exits 0 when nothing is found and 1 when it is.
          MATCHES=$(git --no-pager grep -n --line-number \
            -E "createServerSupabaseClient\(|supabase\.auth\.getUser\(|createServerClient\(|serverSideAuthenticate\(" \
            -- "apps/web/app/(marketing)/**" "apps/web/app/(public)/**" 2>/dev/null || true)
          if [ -n "$MATCHES" ]; then
            echo "❌ Blocking server fetch found in public layout(s):"
            echo "$MATCHES"
            echo ""
            echo "Fix: move auth/profile fetching into a client component that hydrates"
            echo "after initial HTML, or guard the fetch to dashboard/authenticated routes only."
            exit 1
          fi
          echo "✅ No blocking server fetches in public layouts"

  # ── 5. Excessive 'use client' directives (advisory) ─────────────────────────
  avoid-excessive-use-client:
    name: avoid-excessive-use-client — RSC candidates
    runs-on: ubuntu-latest
    needs: ci-health
    if: github.event_name != 'pull_request_target' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Find files with unnecessary use client
        # Exits 0 even when candidates found (severity: warning).
        run: node scripts/find-unused-use-client.js --path apps/web

  # ── 6. New dependency size check (advisory) ──────────────────────────────────
  disallow-large-deps:
    name: disallow-large-deps — dependency size
    runs-on: ubuntu-latest
    needs: ci-health
    if: github.event_name != 'pull_request_target' || github.event.pull_request.head.repo.full_name == github.repository
    continue-on-error: true   # severity: warning — don't block merge, but surface in PR
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0
      - name: Check new dependency sizes
        run: node scripts/check-new-deps.js --package apps/web/package.json --threshold ${{ env.NEW_DEP_THRESHOLD_KB }}

  # ── 7. Dependency version pinning (advisory) ─────────────────────────────────
  dependency-version-lock:
    name: dependency-version-lock — version ranges
    runs-on: ubuntu-latest
    needs: ci-health
    if: github.event_name != 'pull_request_target' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Check dependency version ranges
        # Exits 0 (advisory only — severity: warning).
        run: node scripts/check-dep-versions.js --path apps/web/package.json

  # ── 8. Exception label validation ───────────────────────────────────────────
  ci-flaky-exceptions:
    name: ci-flaky-exceptions — exception label audit
    runs-on: ubuntu-latest
    needs: ci-health
    if: github.event_name != 'pull_request_target' || github.event.pull_request.head.repo.full_name == github.repository
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Validate exception labels
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: node scripts/validate-exceptions.js --pr ${{ github.event.pull_request.number }}

  # ── 9. Lighthouse CI — runs after Vercel preview deploy is live ──────────────
  # This job is marked continue-on-error so that the first run (no baseline) doesn't
  # block the PR. Once baselines are established, set continue-on-error: false.
  ci-lighthouse-guard:
    name: ci-lighthouse-guard — perf score ≥ 90
    runs-on: ubuntu-latest
    needs: [no-next-unoptimized, find-plain-img]
    if: github.event_name != 'pull_request_target' || github.event.pull_request.head.repo.full_name == github.repository
    continue-on-error: true   # Remove once baselines are established.
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - uses: actions/setup-node@v6
        with:
          node-version: '20'
      - name: Install LHCI CLI
        run: npm install -g @lhci/cli@0.14.x
      - name: Run Lighthouse CI
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          LHCI_BUILD_CONTEXT__CURRENT_BRANCH: ${{ github.head_ref }}
          LHCI_BUILD_CONTEXT__COMMIT_TIME: ${{ github.event.pull_request.updated_at }}
          LHCI_BUILD_CONTEXT__CURRENT_HASH: ${{ github.event.pull_request.head.sha }}
          LHCI_BUILD_CONTEXT__GITHUB_REPO_SLUG: ${{ github.repository }}
          # Preview deploy URL is injected by the Vercel GitHub Action or set manually.
          # LHCI_COLLECT_URL can be overridden by a matrix strategy for multiple URLs.
          LHCI_SERVER_BASE_URL: ${{ secrets.LHCI_SERVER_BASE_URL }}
        run: |
          # Determine preview URL: prefer the Vercel preview URL from the PR comments
          # or fall back to the LHCI_COLLECT_URL environment variable.
          PREVIEW_URL="${{ vars.VERCEL_PREVIEW_URL_WEB }}"
          if [ -z "$PREVIEW_URL" ]; then
            echo "::warning::VERCEL_PREVIEW_URL_WEB not set — Lighthouse CI will use URLs from lhci-apps-web.config.js."
            echo "::warning::Set this repository variable to the Vercel preview URL to enable full LHCI runs."
            PREVIEW_URL=""
          fi
          npx lhci autorun \
            --config=./lhci-apps-web.config.js \
            --collect.numberOfRuns=3 \
            ${PREVIEW_URL:+--collect.url="$PREVIEW_URL"} \
            --upload.target=temporary-public-storage \
            || echo "::warning::Lighthouse CI run failed or found regressions. Review the report above."
