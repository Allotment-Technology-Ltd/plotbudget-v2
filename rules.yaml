# Performance & correctness gating rules for apps/web
# Purpose: a single source of truth for CI checks that prevent performance regressions
# Scope: These rules apply to apps/web only. CI should run checks when PRs touch apps/web/**
#
# NOTE: This file is NOT a replacement for .clinerules or .cursorrules.
#       .clinerules        → AI assistant behaviour rules for Roo Code / Cline
#       .cursorrules       → AI assistant behaviour rules for Cursor IDE (legacy format)
#       .cursor/rules/*.mdc → AI assistant behaviour rules for Cursor IDE (modern format)
#       rules.yaml         → CI performance and correctness gating checks (this file)
#
# Implementation notes:
# - "check.command" values are executable shell commands run in CI. Map them to your runner environment.
# - Use environment variables for thresholds to make tuning easy:
#     BUNDLE_MAX_KB (default 300)
#     NEW_DEP_THRESHOLD_KB (default 250)
#     LHCI_PERF_THRESHOLD (default 90)
# - Scripts referenced below are expected at repo root under /scripts (e.g. scripts/check-next-image-optimizer.js)
#
# Severity: "error" = block merge; "warning" = surface in CI/pr comments but may not block (adjust in your CI).
#
# If you add/rename scripts, update the check.command values accordingly.

thresholds:
  bundle_max_kb: 300            # total client-side JS budget (uncompressed); CI will fail if exceeded
  new_dep_threshold_kb: 250     # warn/error when a new dependency's gzipped size > threshold
  lhci_perf_threshold: 90       # Lighthouse performance score threshold
  lhci_regression_threshold: 5  # allowed regression vs baseline before failing

rules:
  - id: no-next-unoptimized
    description: "Ensure Next image optimization is enabled for apps/web (images.unoptimized MUST NOT be true)."
    severity: error
    scope: "apps/web/**"
    check:
      type: script
      command: "node scripts/check-next-image-optimizer.js --path apps/web/next.config.js"
    fail_if: "script exits non-zero or prints 'UNOPTIMIZED=true'"
    fix: "Remove or set images.unoptimized=false in apps/web/next.config.js and configure images.domains or remotePatterns for your image hosts."

  - id: lint-next-no-img
    description: "Disallow raw <img> elements in apps/web; require next/image or approved wrapper."
    severity: error
    scope: "apps/web/**/*.{js,jsx,ts,tsx}"
    check:
      type: eslint
      command: "npm --workspace=apps/web run lint -- --max-warnings=0"
      eslint_rule: "next/no-img-element"
    fail_if: "eslint reports any next/no-img-element violation or any other lint errors"
    fix: "Replace <img> with <Image> from 'next/image' or use the approved <AppImage> wrapper with explicit size or aspect container."

  - id: enforce-image-attrs
    description: "Require LCP/hero images to use next/image with explicit sizing or use width/height on <img> to avoid CLS."
    severity: error
    scope: "apps/web/**/*.{js,jsx,ts,tsx}"
    check:
      type: eslint-or-script
      command: "node scripts/enforce-image-attrs.js --path apps/web --fail"
    fail_if: "script or ESLint custom rule reports violations"
    fix: "Use next/image with sizes/priority for hero images or add explicit width/height/aspect containers to prevent layout shift."

  - id: find-plain-img
    description: "Detect any remaining plain <img> tags in apps/web and fail until they are converted, unless an approved exception is documented."
    severity: error
    scope: "apps/web/**/*.{js,jsx,ts,tsx}"
    check:
      type: script
      command: "node scripts/find-plain-img.js --path apps/web"
    fail_if: "script finds any <img> occurrences outside approved directories/components"
    fix: "Convert to next/image or document an exception (rare)."

  - id: no-blocking-server-fetch-in-public-layouts
    description: "Prevent server-side auth/profile fetches in global public marketing/layouts inside apps/web that block TTFB for public pages."
    severity: error
    scope: "apps/web/app/(marketing)/**, apps/web/app/(public)/**"
    check:
      type: grep
      command: "git --no-pager grep -n --line-number -E \"createServerSupabaseClient\\(|supabase\\.auth\\.getUser\\(|createServerClient\\(|serverSideAuthenticate\\(\" -- apps/web/app || true"
    fail_if: "matches reported"
    fix: "Move profile/auth fetching into a client component (e.g. HeaderClient) that hydrates after initial HTML or guard fetch logic to only run on dashboard/authenticated routes."

  - id: avoid-excessive-use-client
    description: "Warn when files include 'use client' but contain no client-only APIs (unnecessary hydration)."
    severity: warning
    scope: "apps/web/**/*.{ts,tsx,js,jsx}"
    check:
      type: script
      command: "node scripts/find-unused-use-client.js --path apps/web"
    fail_if: "script returns candidate files"
    fix: "Remove 'use client' and convert to server component, or move interactive parts into small client components."

  - id: analytics-deferred
    description: "Analytics & diagnostics (PostHog, Vercel Speed Insights, other heavy scripts) must be initialized after first paint or behind consent on public pages."
    severity: error
    scope: "apps/web/**/*.{js,jsx,ts,tsx}"
    check:
      type: grep
      command: "git --no-pager grep -n --line-number -E \"injectSpeedInsights|inject\\(|posthog\\.(init|capture|flush)|@vercel/speed-insights\" -- apps/web || true"
    fail_if: "initialization found in top-level client entrypoints or server layouts for public pages"
    fix: "Move analytics initialization into a client component that runs inside useEffect after consent/after first paint or replace with non-blocking deferred loader."

  - id: bundle-size-budget
    description: "Enforce a client-side bundle size budget for apps/web builds."
    severity: error
    scope: "apps/web/**"
    check:
      type: bundle-analyzer
      command: "ANALYZE=true npm --workspace=apps/web run build:analyze && node scripts/parse-webpack-stats.js --report apps/web/.next/analyze/client.html --max-kb ${BUNDLE_MAX_KB:-300}"
    fail_if: "parse-webpack-stats.js exits non-zero (bundle size > BUNDLE_MAX_KB)"
    fix: "Run bundle analyzer, identify top modules, then code-split/dynamic-import or replace heavy libraries. Consider lazy-loading icon sets / large UI chunks."

  - id: disallow-large-deps
    description: "Warn or block commits that add large dependencies to apps/web package.json (prevent adding heavyweight libs without review)."
    severity: warning
    scope: "apps/web/package.json"
    check:
      type: script
      command: "node scripts/check-new-deps.js --package apps/web/package.json --threshold ${NEW_DEP_THRESHOLD_KB:-250}"
    fail_if: "new dependency gzipped size > NEW_DEP_THRESHOLD_KB"
    fix: "Choose lighter alternatives, import only submodules, or lazy-load the dependency."

  - id: dependency-version-lock
    description: "Require explicit version ranges for deps in apps/web package.json to avoid accidental upgrades that increase size."
    severity: warning
    scope: "apps/web/package.json"
    check:
      type: script
      command: "node scripts/check-dep-versions.js --path apps/web/package.json"
    fail_if: "wildcard or caret ranges flagged (policy-specific)"
    fix: "Pin or set conservative semver ranges for production dependencies."

  - id: ci-lighthouse-guard
    description: "Run Lighthouse CI on preview deploys and fail PRs that drop performance below threshold or regress significantly vs baseline."
    severity: error
    scope: "PRs touching apps/web/** with preview deployments"
    check:
      type: lhci
      command: "npx @lhci/cli@0.9.x autorun --config=./lhci-apps-web.config.js --collect.numberOfRuns=3 --upload.target=temporary-public-storage"
    fail_if: "Lighthouse performance < ${LHCI_PERF_THRESHOLD:-90} OR regression > ${LHCI_REGRESSION_THRESHOLD:-5}"
    fix: "Address LCP/LCP images, JS payload, and TTFB causes. If preview deploy not available in the environment, document how to enable and allow the job to be optional."

  - id: ci-flaky-exceptions
    description: "Allow documented exceptions for checks (owner-approved) but require explicit PR label and linked issue for long-term exceptions."
    severity: warning
    scope: "repo"
    check:
      type: metadata
      command: "node scripts/validate-exceptions.js --pr $PR_NUMBER"
    fail_if: "exception labels found without linked issue or owner approval"
    fix: "Add linked issue describing the exception, mitigation plan, and timeframe; update exception metadata."

  - id: ci-health
    description: "Ensure required helper scripts and CI config exist before gating (fail early with actionable message)."
    severity: error
    scope: "repo-root"
    check:
      type: files-exist
      command: "node scripts/validate-ci-prereqs.js --expect scripts/check-next-image-optimizer.js,scripts/find-plain-img.js,scripts/parse-webpack-stats.js,.github/workflows/perf-guard.yml"
    fail_if: "missing required script or workflow files"
    fix: "Add the referenced scripts/workflows to the repo root or update rules.yaml to reflect new locations."

notes:
  - "CI should map rule severities to job failure behavior. Errors should fail PR merges by default."
  - "Use environment variables in CI to set thresholds (BUNDLE_MAX_KB, NEW_DEP_THRESHOLD_KB, LHCI_PERF_THRESHOLD)."
  - "Where 'check.type' is 'script', the CI runner should run the command and consider non-zero exit codes as failures."
  - "For 'eslint' checks, prefer running with --max-warnings=0 to ensure warnings are surfaced as failures when desired."
  - "Adjust scopes to match your monorepo layout (the 'scope' field is advisory—CI path filters should also be used)."
